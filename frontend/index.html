<!DOCTYPE html>
<!-- Version: 2026-02-02-v2 - Added LinkedIn Auth, Employment Types, Company Careers -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Applier - AI-Powered Job Application Automation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .toggle-btn {
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: #8b5cf6;
            color: white;
        }
        .progress-bar {
            transition: width 0.5s ease-out;
        }
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 px-4">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold">üöÄ Job Applier</h1>
            <p class="text-purple-100 mt-1">AI-powered job application automation</p>
        </div>
    </header>

    <main class="max-w-6xl mx-auto py-8 px-4">
        <!-- Progress Bar (shown during batch apply) -->
        <div id="progress-container" class="mb-6 card p-4 hidden">
            <div class="flex justify-between items-center mb-2">
                <span class="font-medium">üì§ Applying to jobs...</span>
                <span id="progress-text" class="text-sm text-gray-600">0 / 0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="progress-bar bg-purple-600 h-4 rounded-full" style="width: 0%"></div>
            </div>
            <div id="progress-status" class="mt-2 text-sm text-gray-600"></div>
        </div>

        <!-- Status Bar -->
        <div id="status-bar" class="mb-6 p-4 rounded-lg hidden">
            <span id="status-message"></span>
        </div>

        <!-- Daily Limit Display -->
        <div id="rate-limit-card" class="mb-6 card p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">üìä</div>
                    <div>
                        <h3 class="font-semibold text-gray-800">Daily Applications</h3>
                        <p class="text-sm text-gray-600">Rolling 24-hour window</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-center">
                        <div id="sent-count" class="text-2xl font-bold text-purple-600">0</div>
                        <div class="text-xs text-gray-500">Sent</div>
                    </div>
                    <div class="text-gray-300 text-2xl">/</div>
                    <div class="text-center">
                        <div class="flex items-center gap-2">
                            <input type="number" id="daily-limit-input" min="1" max="1000" value="10"
                                class="w-16 text-2xl font-bold text-center border-b-2 border-purple-200 focus:border-purple-500 outline-none bg-transparent">
                        </div>
                        <div class="text-xs text-gray-500">Daily Limit</div>
                    </div>
                    <div class="text-center ml-4 px-4 py-2 rounded-lg" id="remaining-badge">
                        <div id="remaining-count" class="text-xl font-bold">10</div>
                        <div class="text-xs">Remaining</div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="limit-progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- Left Column: Setup -->
            <div class="space-y-6">
                <!-- Resume Upload -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">üìÑ 1. Upload Resume</h2>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-500 transition-colors">
                        <input type="file" id="resume-input" accept=".pdf,.docx,.txt" class="hidden">
                        <label for="resume-input" class="cursor-pointer">
                            <div class="text-4xl mb-2">üì§</div>
                            <p class="text-gray-600">Drop your resume here or click to upload</p>
                            <p class="text-sm text-gray-400 mt-1">PDF, DOCX, or TXT</p>
                        </label>
                    </div>
                    <div id="resume-status" class="mt-4 text-sm text-gray-600"></div>
                </div>

                <!-- Profile -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">üë§ 2. Your Profile</h2>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="first_name" placeholder="First Name" required
                                class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            <input type="text" id="last_name" placeholder="Last Name" required
                                class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>
                        <input type="email" id="email" placeholder="Email" required
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="tel" id="phone" placeholder="Phone" required
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="url" id="linkedin_url" placeholder="LinkedIn URL (optional)"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="number" id="years_experience" placeholder="Years of Experience"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            Save Profile
                        </button>
                    </form>
                </div>

                <!-- LinkedIn Auth -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">üîê LinkedIn Auth (Optional)</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        For LinkedIn Easy Apply, paste your <code>li_at</code> session cookie. 
                        <a href="#" onclick="showCookieHelp()" class="text-purple-600 underline">How to get it?</a>
                    </p>
                    <div id="cookie-help" class="hidden mb-4 p-3 bg-blue-50 rounded-lg text-sm">
                        <ol class="list-decimal ml-4 space-y-1">
                            <li>Open LinkedIn in Chrome and log in</li>
                            <li>Press F12 ‚Üí Application tab ‚Üí Cookies ‚Üí linkedin.com</li>
                            <li>Find <code>li_at</code> and copy its Value</li>
                            <li>Paste below (expires in ~1 year)</li>
                        </ol>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" id="linkedin_cookie" placeholder="Paste li_at cookie value"
                            class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none font-mono text-sm">
                        <button onclick="saveLinkedInCookie()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Save
                        </button>
                    </div>
                    <div id="cookie-status" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- Right Column: Search & Apply -->
            <div class="space-y-6">
                <!-- Job Search -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">üîç 3. Search Jobs</h2>
                    <form id="search-form" class="space-y-4">
                        <input type="text" id="roles" placeholder="Job Titles (comma-separated)" 
                            value="Software Engineer, Backend Developer"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="text" id="locations" placeholder="Locations (comma-separated)" 
                            value="Remote, San Francisco"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        
                        <!-- Country Filter -->
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="us-only" checked class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="text-sm font-medium text-gray-700">üá∫üá∏ US Jobs Only</span>
                            </label>
                            <select id="country-filter" class="px-3 py-1 text-sm border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                                <option value="US" selected>United States</option>
                                <option value="CA">Canada</option>
                                <option value="GB">United Kingdom</option>
                                <option value="DE">Germany</option>
                                <option value="ALL">All Countries</option>
                            </select>
                        </div>
                        
                        <!-- Work Type Toggles -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Work Type</label>
                            <div class="flex gap-2">
                                <button type="button" id="toggle-remote" class="toggle-btn active flex-1 px-4 py-2 border rounded-lg text-sm font-medium">
                                    üè† Remote
                                </button>
                                <button type="button" id="toggle-hybrid" class="toggle-btn flex-1 px-4 py-2 border rounded-lg text-sm font-medium">
                                    üîÑ Hybrid
                                </button>
                                <button type="button" id="toggle-onsite" class="toggle-btn flex-1 px-4 py-2 border rounded-lg text-sm font-medium">
                                    üè¢ On-site
                                </button>
                            </div>
                        </div>

                        <!-- Employment Type Toggles -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Employment Type</label>
                            <div class="flex gap-2 flex-wrap">
                                <button type="button" id="toggle-fulltime" class="toggle-btn active px-4 py-2 border rounded-lg text-sm font-medium">
                                    üíº Full-time
                                </button>
                                <button type="button" id="toggle-contract" class="toggle-btn px-4 py-2 border rounded-lg text-sm font-medium">
                                    üìù Contract
                                </button>
                                <button type="button" id="toggle-temporary" class="toggle-btn px-4 py-2 border rounded-lg text-sm font-medium">
                                    ‚è±Ô∏è Temporary
                                </button>
                                <button type="button" id="toggle-parttime" class="toggle-btn px-4 py-2 border rounded-lg text-sm font-medium">
                                    üïê Part-time
                                </button>
                            </div>
                        </div>

                        <!-- Minimum Compensation Slider -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Minimum Salary: <span id="salary-display" class="text-purple-600 font-bold">$80,000</span>
                            </label>
                            <input type="range" id="min-salary" min="0" max="300000" step="5000" value="80000"
                                class="w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>Any</span>
                                <span>$150k</span>
                                <span>$300k+</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="easy_apply_only" checked class="rounded text-purple-600">
                                <span class="text-sm">Easy Apply only</span>
                            </label>
                            <select id="posted_within" class="px-3 py-2 border rounded-lg">
                                <option value="1">Past 24 hours</option>
                                <option value="7" selected>Past week</option>
                                <option value="30">Past month</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            üîç Search Jobs
                        </button>
                        <p class="text-xs text-gray-400 text-center mt-1">‚ö†Ô∏è Search requires local browser. Use direct URL below for cloud.</p>
                    </form>
                </div>

                <!-- Results -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üìã Results</h2>
                        <span id="results-count" class="text-sm text-gray-500"></span>
                    </div>
                    <div id="results" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8">Search results will appear here</p>
                    </div>
                </div>

                <!-- Batch Apply Settings -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">‚ö° Batch Apply</h2>
                    
                    <!-- Number of Applications -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Applications to send: <span id="app-count-display" class="text-purple-600 font-bold">10</span>
                        </label>
                        <input type="range" id="app-count" min="1" max="50" step="1" value="10"
                            class="w-full">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1</span>
                            <span>25</span>
                            <span>50</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-4 mb-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="generate_cover_letter" checked class="rounded text-purple-600">
                            <span class="text-sm">Generate cover letters</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="auto_submit" class="rounded text-red-600">
                            <span class="text-sm text-red-600">Auto-submit (‚ö†Ô∏è)</span>
                        </label>
                    </div>

                    <button id="batch-apply-btn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        üöÄ Apply to Selected Jobs (<span id="selected-count">0</span>)
                    </button>
                </div>

                <!-- Quick Apply -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">üéØ Single Job Apply</h2>
                    <div id="linkedin-warning" class="mb-3 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800 hidden">
                        ‚ö†Ô∏è <strong>LinkedIn requires auth!</strong> Add your <code>li_at</code> cookie in the LinkedIn Auth section (left side) before applying to LinkedIn jobs.
                    </div>
                    <form id="apply-form" class="space-y-4">
                        <input type="url" id="job_url" placeholder="Paste any job URL (LinkedIn, Indeed, Greenhouse, company careers, etc.)"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" oninput="checkLinkedInWarning(this.value)">
                        <p class="text-xs text-gray-500">Supports: LinkedIn, Indeed, Greenhouse, Workday, Lever, + any company career page</p>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            üéØ Apply Now
                        </button>
                    </form>
                </div>
                
                <!-- Company Careers Scraper -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">üè¢ Company Careers</h2>
                    <p class="text-sm text-gray-600 mb-3">Scrape jobs directly from a company's careers page</p>
                    <form id="company-search-form" class="space-y-4">
                        <input type="url" id="careers_url" placeholder="Company careers page URL (e.g., https://stripe.com/jobs)"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="text" id="company_roles" placeholder="Filter by role (optional, e.g., Engineer)"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            üîç Find Jobs on This Site
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Applications Log -->
        <div class="card p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">üìä Application History</h2>
            <div id="applications-log" class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Job</th>
                            <th class="px-4 py-2 text-left">Company</th>
                            <th class="px-4 py-2 text-left">Platform</th>
                            <th class="px-4 py-2 text-left">Status</th>
                            <th class="px-4 py-2 text-left">Time</th>
                        </tr>
                    </thead>
                    <tbody id="applications-tbody">
                        <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No applications yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // API Base URL - Job Applier Backend (Fly.io)
        const API_BASE = 'https://job-applier-api.fly.dev';
        
        const USER_ID = 'default';
        let selectedJobs = new Set();
        let searchResults = [];

        // === LinkedIn Cookie Functions ===
        let linkedInCookieSet = false;
        
        function showCookieHelp() {
            const helpEl = document.getElementById('cookie-help');
            helpEl.classList.toggle('hidden');
        }
        
        function checkLinkedInWarning(url) {
            const warning = document.getElementById('linkedin-warning');
            if (url.toLowerCase().includes('linkedin.com') && !linkedInCookieSet) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        async function saveLinkedInCookie() {
            const cookie = document.getElementById('linkedin_cookie').value.trim();
            if (!cookie) {
                document.getElementById('cookie-status').innerHTML = '<span class="text-red-600">Please enter a cookie value</span>';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/settings?user_id=${USER_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ daily_limit: parseInt(document.getElementById('daily-limit-input').value) || 10, linkedin_cookie: cookie })
                });
                const data = await res.json();
                
                if (data.linkedin_cookie_set) {
                    linkedInCookieSet = true;
                    document.getElementById('cookie-status').innerHTML = '<span class="text-green-600">‚úÖ LinkedIn cookie saved! You can now use Easy Apply.</span>';
                    document.getElementById('linkedin_cookie').value = '';
                    document.getElementById('linkedin-warning')?.classList.add('hidden');
                } else {
                    document.getElementById('cookie-status').innerHTML = '<span class="text-red-600">Failed to save cookie</span>';
                }
            } catch (e) {
                document.getElementById('cookie-status').innerHTML = `<span class="text-red-600">Error: ${e.message}</span>`;
            }
        }

        // === Company Careers Search ===
        document.getElementById('company-search-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const careersUrl = document.getElementById('careers_url').value;
            const roles = document.getElementById('company_roles').value;
            
            if (!careersUrl) {
                showStatus('Please enter a careers page URL', 'error');
                return;
            }
            
            document.getElementById('results').innerHTML = '<p class="text-center py-4">üîç Scraping company careers page...</p>';
            
            try {
                const res = await fetch(`${API_BASE}/jobs/search?platform=company`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        roles: roles ? [roles] : [],
                        locations: [],
                        careers_url: careersUrl
                    })
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ detail: 'Server error' }));
                    throw new Error(errorData.detail || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                searchResults = data.jobs || [];
                
                document.getElementById('results-count').textContent = `${data.count} jobs found`;
                
                if (searchResults.length === 0) {
                    document.getElementById('results').innerHTML = '<p class="text-center py-4 text-gray-500">No jobs found on that page</p>';
                } else {
                    renderResults();
                }
                showStatus(`Found ${data.count} jobs from company careers page`, 'success');
            } catch (err) {
                showStatus('Company search: ' + err.message, 'error');
                document.getElementById('results').innerHTML = `<p class="text-center py-4 text-amber-600">${err.message}</p>`;
            }
        });

        // === Rate Limit Management ===
        async function loadRateLimitStatus() {
            try {
                const res = await fetch(`${API_BASE}/settings?user_id=${USER_ID}`);
                const data = await res.json();
                updateRateLimitDisplay(data);
            } catch (e) {
                console.error('Failed to load rate limit:', e);
            }
        }

        function updateRateLimitDisplay(data) {
            // Check if LinkedIn cookie is set
            if (data.linkedin_cookie_set) {
                linkedInCookieSet = true;
                document.getElementById('cookie-status').innerHTML = '<span class="text-green-600">‚úÖ Cookie active</span>';
            }
            const sent = data.sent_last_24h || 0;
            const limit = data.daily_limit || 10;
            const remaining = data.remaining || (limit - sent);
            const percentage = Math.min(100, (sent / limit) * 100);
            
            document.getElementById('sent-count').textContent = sent;
            document.getElementById('daily-limit-input').value = limit;
            document.getElementById('remaining-count').textContent = remaining;
            document.getElementById('limit-progress-bar').style.width = `${percentage}%`;
            
            // Update badge color based on remaining
            const badge = document.getElementById('remaining-badge');
            if (remaining === 0) {
                badge.className = 'text-center ml-4 px-4 py-2 rounded-lg bg-red-100 text-red-800';
            } else if (remaining <= 3) {
                badge.className = 'text-center ml-4 px-4 py-2 rounded-lg bg-yellow-100 text-yellow-800';
            } else {
                badge.className = 'text-center ml-4 px-4 py-2 rounded-lg bg-green-100 text-green-800';
            }
            
            // Update progress bar color
            const progressBar = document.getElementById('limit-progress-bar');
            if (percentage >= 100) {
                progressBar.className = 'bg-red-500 h-2 rounded-full transition-all duration-300';
            } else if (percentage >= 70) {
                progressBar.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300';
            } else {
                progressBar.className = 'bg-purple-600 h-2 rounded-full transition-all duration-300';
            }
        }

        // Daily limit input change handler
        document.getElementById('daily-limit-input').addEventListener('change', async (e) => {
            const newLimit = parseInt(e.target.value);
            if (newLimit < 1 || newLimit > 1000) {
                showStatus('Daily limit must be between 1 and 1000', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/settings?user_id=${USER_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ daily_limit: newLimit })
                });
                const data = await res.json();
                updateRateLimitDisplay(data);
                showStatus(`Daily limit updated to ${newLimit}`, 'success');
            } catch (e) {
                showStatus('Failed to update limit', 'error');
            }
        });

        // Load rate limit on page load
        loadRateLimitStatus();
        // Refresh every 60 seconds
        setInterval(loadRateLimitStatus, 60000);

        // Work type toggles
        const workTypes = { remote: true, hybrid: false, onsite: false };
        const employmentTypes = { fulltime: true, contract: false, temporary: false, parttime: false };
        
        // Work type buttons
        ['remote', 'hybrid', 'onsite'].forEach(type => {
            document.getElementById(`toggle-${type}`)?.addEventListener('click', (e) => {
                workTypes[type] = !workTypes[type];
                e.target.classList.toggle('active', workTypes[type]);
            });
        });
        
        // Employment type buttons
        ['fulltime', 'contract', 'temporary', 'parttime'].forEach(type => {
            document.getElementById(`toggle-${type}`)?.addEventListener('click', (e) => {
                employmentTypes[type] = !employmentTypes[type];
                e.target.classList.toggle('active', employmentTypes[type]);
            });
        });

        // Salary slider
        document.getElementById('min-salary').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            document.getElementById('salary-display').textContent = val === 0 ? 'Any' : `$${val.toLocaleString()}`;
        });

        // App count slider
        document.getElementById('app-count').addEventListener('input', (e) => {
            document.getElementById('app-count-display').textContent = e.target.value;
        });

        // Status helper
        function showStatus(message, type = 'info') {
            const bar = document.getElementById('status-bar');
            const msg = document.getElementById('status-message');
            bar.className = `mb-6 p-4 rounded-lg ${
                type === 'error' ? 'bg-red-100 text-red-800' :
                type === 'success' ? 'bg-green-100 text-green-800' :
                'bg-blue-100 text-blue-800'
            }`;
            msg.textContent = message;
            bar.classList.remove('hidden');
            setTimeout(() => bar.classList.add('hidden'), 5000);
        }

        // Progress bar
        function updateProgress(current, total, status = '') {
            const container = document.getElementById('progress-container');
            const bar = document.getElementById('progress-bar');
            const text = document.getElementById('progress-text');
            const statusEl = document.getElementById('progress-status');
            
            if (total === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            const percent = Math.round((current / total) * 100);
            bar.style.width = percent + '%';
            text.textContent = `${current} / ${total}`;
            statusEl.textContent = status;
        }

        // Resume Upload
        document.getElementById('resume-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                showStatus('Uploading and parsing resume...');
                const res = await fetch(`${API_BASE}/resume/upload?user_id=${USER_ID}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                document.getElementById('resume-status').innerHTML = `
                    <div class="p-3 bg-green-50 rounded-lg">
                        <strong>‚úÖ Resume uploaded:</strong> ${file.name}<br>
                        <span class="text-gray-600">Skills: ${data.parsed_data?.skills?.slice(0,5).join(', ') || 'Parsing...'}</span>
                    </div>
                `;
                showStatus('Resume uploaded successfully!', 'success');
            } catch (err) {
                showStatus('Failed to upload resume: ' + err.message, 'error');
            }
        });

        // Profile Form
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const profile = {
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                linkedin_url: document.getElementById('linkedin_url').value || null,
                years_experience: parseInt(document.getElementById('years_experience').value) || null
            };

            try {
                const res = await fetch(`${API_BASE}/profile?user_id=${USER_ID}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(profile)
                });
                showStatus('Profile saved!', 'success');
            } catch (err) {
                showStatus('Failed to save profile: ' + err.message, 'error');
            }
        });

        // Job Search
        document.getElementById('search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Build locations based on work type toggles
            let locations = document.getElementById('locations').value.split(',').map(s => s.trim());
            if (workTypes.remote && !locations.some(l => l.toLowerCase().includes('remote'))) {
                locations.push('Remote');
            }

            // Get country filter
            const usOnly = document.getElementById('us-only').checked;
            const countryFilter = document.getElementById('country-filter').value;
            
            // If US only is checked, ensure US locations
            if (usOnly && !locations.some(l => l.toLowerCase().includes('united states'))) {
                locations = locations.map(l => {
                    if (l.toLowerCase() === 'remote') return 'Remote, United States';
                    return l + ', United States';
                });
            }

            const search = {
                roles: document.getElementById('roles').value.split(',').map(s => s.trim()),
                locations: locations,
                easy_apply_only: document.getElementById('easy_apply_only').checked,
                posted_within_days: parseInt(document.getElementById('posted_within').value),
                min_salary: parseInt(document.getElementById('min-salary').value) || null,
                work_types: Object.entries(workTypes).filter(([k,v]) => v).map(([k]) => k),
                employment_types: Object.entries(employmentTypes).filter(([k,v]) => v).map(([k]) => k),
                country: usOnly ? 'US' : countryFilter
            };

            document.getElementById('results').innerHTML = '<p class="text-center py-4">üîç Searching...</p>';
            selectedJobs.clear();
            updateSelectedCount();

            try {
                const res = await fetch(`${API_BASE}/jobs/search?platform=linkedin`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(search)
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ detail: 'Server error' }));
                    throw new Error(errorData.detail || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                searchResults = data.jobs || [];
                
                document.getElementById('results-count').textContent = `${data.count} jobs found`;
                
                if (searchResults.length === 0) {
                    document.getElementById('results').innerHTML = '<p class="text-center py-4 text-gray-500">No jobs found</p>';
                } else {
                    renderResults();
                }
                showStatus(`Found ${data.count} jobs`, 'success');
            } catch (err) {
                const errorMsg = err.message.includes('Browser automation') 
                    ? '‚ö†Ô∏è Search requires browser automation (not available on cloud). Use "Single Job Apply" with a direct job URL instead!'
                    : err.message;
                showStatus('Search: ' + errorMsg, 'error');
                document.getElementById('results').innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-amber-600 mb-2">üîç Job search requires browser automation</p>
                        <p class="text-sm text-gray-500">Paste a job URL directly in "Single Job Apply" below instead!</p>
                    </div>`;
            }
        });

        function renderResults() {
            document.getElementById('results').innerHTML = searchResults.map((job, idx) => `
                <div class="p-3 border rounded-lg hover:bg-gray-50 ${selectedJobs.has(idx) ? 'ring-2 ring-purple-500 bg-purple-50' : ''}">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" ${selectedJobs.has(idx) ? 'checked' : ''} 
                            onchange="toggleJob(${idx})"
                            class="mt-1 rounded text-purple-600">
                        <div class="flex-1">
                            <div class="font-medium">${job.title}</div>
                            <div class="text-sm text-gray-600">${job.company} ‚Ä¢ ${job.location}</div>
                            <div class="flex items-center gap-2 mt-2 flex-wrap">
                                ${job.easy_apply ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Easy Apply</span>' : ''}
                                ${job.remote ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">üè† Remote</span>' : ''}
                                <a href="${job.url}" target="_blank" class="text-xs text-purple-600 hover:underline">View ‚Üí</a>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleJob(idx) {
            if (selectedJobs.has(idx)) {
                selectedJobs.delete(idx);
            } else {
                selectedJobs.add(idx);
            }
            updateSelectedCount();
            renderResults();
        }

        function updateSelectedCount() {
            const count = selectedJobs.size;
            document.getElementById('selected-count').textContent = count;
            document.getElementById('batch-apply-btn').disabled = count === 0;
        }

        // Batch Apply
        document.getElementById('batch-apply-btn').addEventListener('click', async () => {
            const maxApps = parseInt(document.getElementById('app-count').value);
            const jobsToApply = Array.from(selectedJobs).slice(0, maxApps).map(idx => searchResults[idx]);
            
            if (jobsToApply.length === 0) {
                showStatus('No jobs selected', 'error');
                return;
            }

            const autoSubmit = document.getElementById('auto_submit').checked;
            const generateCover = document.getElementById('generate_cover_letter').checked;

            updateProgress(0, jobsToApply.length, 'Starting...');
            
            for (let i = 0; i < jobsToApply.length; i++) {
                const job = jobsToApply[i];
                updateProgress(i, jobsToApply.length, `Applying to ${job.company}...`);
                
                try {
                    await fetch(`${API_BASE}/apply?user_id=${USER_ID}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            job_url: job.url,
                            auto_submit: autoSubmit,
                            generate_cover_letter: generateCover
                        })
                    });
                } catch (err) {
                    console.error(`Failed to apply to ${job.company}:`, err);
                }
                
                // Small delay between applications
                await new Promise(r => setTimeout(r, 2000));
            }
            
            updateProgress(jobsToApply.length, jobsToApply.length, '‚úÖ Complete!');
            showStatus(`Applied to ${jobsToApply.length} jobs!`, 'success');
            loadApplications();
            loadRateLimitStatus();  // Refresh rate limit display
            
            // Hide progress after delay
            setTimeout(() => updateProgress(0, 0), 3000);
        });

        // Single Apply Form
        document.getElementById('apply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const jobUrl = document.getElementById('job_url').value;
            if (!jobUrl) return;
            
            try {
                showStatus('Applying to job...');
                const res = await fetch(`${API_BASE}/apply?user_id=${USER_ID}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_url: jobUrl,
                        auto_submit: document.getElementById('auto_submit').checked,
                        generate_cover_letter: document.getElementById('generate_cover_letter').checked
                    })
                });
                const data = await res.json();
                showStatus(`Application ${data.status}: ${data.application_id}`, 'success');
                document.getElementById('job_url').value = '';
                loadApplications();
                loadRateLimitStatus();  // Refresh rate limit display
            } catch (err) {
                showStatus('Application failed: ' + err.message, 'error');
                loadRateLimitStatus();  // Still refresh to show updated count
            }
        });

        async function loadApplications() {
            try {
                const res = await fetch(`${API_BASE}/applications?user_id=${USER_ID}`);
                const data = await res.json();
                
                if (data.applications.length === 0) {
                    document.getElementById('applications-tbody').innerHTML = 
                        '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No applications yet</td></tr>';
                } else {
                    document.getElementById('applications-tbody').innerHTML = data.applications.map(app => `
                        <tr class="border-t">
                            <td class="px-4 py-2">${app.job_title || 'Job'}</td>
                            <td class="px-4 py-2">${app.company || '-'}</td>
                            <td class="px-4 py-2">
                                <span class="text-xs px-2 py-1 rounded bg-gray-100">${app.platform || 'linkedin'}</span>
                            </td>
                            <td class="px-4 py-2">
                                <span class="px-2 py-1 rounded text-xs ${
                                    app.status === 'submitted' ? 'bg-green-100 text-green-800' :
                                    app.status === 'pending_review' ? 'bg-yellow-100 text-yellow-800' :
                                    app.status === 'error' ? 'bg-red-100 text-red-800' :
                                    'bg-gray-100'
                                }">${app.status}</span>
                            </td>
                            <td class="px-4 py-2 text-sm text-gray-500">${new Date(app.timestamp).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load applications:', err);
            }
        }

        // Load applications on page load
        loadApplications();
        setInterval(loadApplications, 10000);
    </script>
</body>
</html>
