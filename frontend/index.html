<!DOCTYPE html>
<!-- Version: 2026-02-03-v5 - Auto-suggest job titles from resume, speedometer UI, parallel sessions -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; connect-src 'self' https://job-applier-api.fly.dev https://*.fly.dev;">
    <title>Job Applier - AI-Powered Job Application Automation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .toggle-btn { transition: all 0.2s; }
        .toggle-btn.active { background: #8b5cf6; color: white; }
        .progress-bar { transition: width 0.5s ease-out; }
        input[type="range"] { -webkit-appearance: none; height: 8px; border-radius: 4px; background: #e2e8f0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #8b5cf6; cursor: pointer; }
        .auth-section { display: none; }
        .auth-section.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 px-4">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Job Applier</h1>
                <p class="text-purple-100 mt-1">AI-powered job application automation</p>
            </div>
            <div id="auth-status" class="text-sm">
                <span id="user-email" class="hidden mr-4"></span>
                <button id="logout-btn" onclick="logout()" class="hidden px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30">Logout</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto py-8 px-4">
        <!-- Auth Section (shown when not logged in) -->
        <div id="auth-container" class="auth-section active">
            <div class="max-w-md mx-auto card p-8">
                <h2 class="text-2xl font-bold text-center mb-6">Welcome to Job Applier</h2>

                <div id="login-form-container">
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="Email" required
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="password" id="login-password" placeholder="Password" required minlength="8"
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-medium">
                            Login
                        </button>
                    </form>
                    <p class="text-center mt-4 text-gray-600">
                        Don't have an account? <a href="#" onclick="showRegister()" class="text-purple-600 hover:underline">Register</a>
                    </p>
                </div>

                <div id="register-form-container" class="hidden">
                    <form id="register-form" class="space-y-4">
                        <input type="email" id="register-email" placeholder="Email" required
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="password" id="register-password" placeholder="Password (min 8 chars, letters + numbers)" required minlength="8" pattern="^(?=.*[A-Za-z])(?=.*\d).{8,}$"
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="password" id="register-confirm" placeholder="Confirm Password" required
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-medium">
                            Create Account
                        </button>
                    </form>
                    <p class="text-center mt-4 text-gray-600">
                        Already have an account? <a href="#" onclick="showLogin()" class="text-purple-600 hover:underline">Login</a>
                    </p>
                </div>

                <div id="auth-error" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden"></div>
            </div>
        </div>

        <!-- Main App (shown when logged in) -->
        <div id="app-container" class="auth-section">
            <!-- Progress Bar -->
            <div id="progress-container" class="mb-6 card p-4 hidden">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">Applying to jobs...</span>
                    <span id="progress-text" class="text-sm text-gray-600">0 / 0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progress-bar" class="progress-bar bg-purple-600 h-4 rounded-full" style="width: 0%"></div>
                </div>
                <div id="progress-status" class="mt-2 text-sm text-gray-600"></div>
            </div>

            <!-- Status Bar -->
            <div id="status-bar" class="mb-6 p-4 rounded-lg hidden">
                <span id="status-message"></span>
            </div>

            <!-- Speed Settings Card with Speedometer -->
            <div id="speed-settings-card" class="mb-6 card p-6">
                <div class="flex items-center justify-between flex-wrap gap-6">
                    <!-- Speedometer Visual -->
                    <div class="flex flex-col items-center">
                        <div class="relative w-40 h-24 overflow-hidden">
                            <!-- Speedometer arc background -->
                            <svg viewBox="0 0 100 50" class="w-full h-full">
                                <!-- Background arc -->
                                <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#e2e8f0" stroke-width="8" stroke-linecap="round"/>
                                <!-- Speed zones -->
                                <path d="M 10 50 A 40 40 0 0 1 30 15" fill="none" stroke="#10b981" stroke-width="8" stroke-linecap="round"/>
                                <path d="M 30 15 A 40 40 0 0 1 50 10" fill="none" stroke="#f59e0b" stroke-width="8" stroke-linecap="round"/>
                                <path d="M 50 10 A 40 40 0 0 1 70 15" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round"/>
                                <path d="M 70 15 A 40 40 0 0 1 90 50" fill="none" stroke="#ef4444" stroke-width="8" stroke-linecap="round"/>
                                <!-- Needle -->
                                <line id="speed-needle" x1="50" y1="50" x2="50" y2="15" stroke="#1f2937" stroke-width="3" stroke-linecap="round" transform="rotate(-90, 50, 50)"/>
                                <!-- Center dot -->
                                <circle cx="50" cy="50" r="5" fill="#1f2937"/>
                            </svg>
                        </div>
                        <div id="speed-label" class="text-2xl font-bold text-gray-800 mt-2">10 sessions</div>
                        <div class="text-sm text-gray-500">Parallel Speed</div>
                    </div>
                    
                    <!-- Speed Slider -->
                    <div class="flex-1 max-w-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‚ö° Application Speed</label>
                        <input type="range" id="parallel-sessions" min="1" max="100" value="10" 
                            class="w-full h-3 bg-gradient-to-r from-green-400 via-yellow-400 via-orange-400 to-red-500 rounded-lg appearance-none cursor-pointer"
                            oninput="updateSpeedometer(this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>üê¢ Slow (1)</span>
                            <span>üöÄ Fast (50)</span>
                            <span>üî• Turbo (100)</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Higher = faster applications, but uses more BrowserBase sessions</p>
                    </div>

                    <!-- Speed Stats -->
                    <div class="text-center bg-gray-50 px-6 py-3 rounded-lg">
                        <div id="est-rate" class="text-3xl font-bold text-purple-600">~4</div>
                        <div class="text-xs text-gray-500">apps/minute</div>
                    </div>
                </div>
            </div>

            <!-- Rate Limit Card -->
            <div id="rate-limit-card" class="mb-6 card p-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <div class="text-3xl">üìä</div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Daily Applications</h3>
                            <p class="text-sm text-gray-600">Rolling 24-hour window</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-center">
                            <div id="sent-count" class="text-2xl font-bold text-purple-600">0</div>
                            <div class="text-xs text-gray-500">Sent</div>
                        </div>
                        <div class="text-gray-300 text-2xl">/</div>
                        <div class="text-center">
                            <input type="number" id="daily-limit-input" min="1" max="1000" value="10"
                                class="w-16 text-2xl font-bold text-center border-b-2 border-purple-200 focus:border-purple-500 outline-none bg-transparent">
                            <div class="text-xs text-gray-500">Daily Limit</div>
                        </div>
                        <div class="text-center ml-4 px-4 py-2 rounded-lg bg-green-100 text-green-800" id="remaining-badge">
                            <div id="remaining-count" class="text-xl font-bold">10</div>
                            <div class="text-xs">Remaining</div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="limit-progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Resume Upload -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4">üìÑ 1. Upload Resume</h2>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-500 transition-colors">
                            <input type="file" id="resume-input" accept=".pdf,.docx,.txt" class="hidden">
                            <label for="resume-input" class="cursor-pointer">
                                <div class="text-4xl mb-2">üì§</div>
                                <p class="text-gray-600">Drop your resume here or click to upload</p>
                                <p class="text-sm text-gray-400 mt-1">PDF, DOCX, or TXT (max 10MB)</p>
                            </label>
                        </div>
                        <div id="resume-status" class="mt-4 text-sm text-gray-600"></div>
                        
                        <!-- Job Title Suggestions -->
                        <div id="title-suggestions" class="mt-4 hidden">
                            <div class="p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200">
                                <h3 class="font-semibold text-purple-800 mb-2 flex items-center gap-2">
                                    üí° AI Job Title Suggestions
                                    <button onclick="loadTitleSuggestions()" class="text-xs px-2 py-1 bg-purple-100 rounded hover:bg-purple-200">Refresh</button>
                                </h3>
                                <div id="suggested-roles-list" class="flex flex-wrap gap-2 mb-3">
                                    <!-- Dynamically populated -->
                                </div>
                                <div id="suggested-titles-details" class="space-y-2 text-sm">
                                    <!-- Detailed suggestions -->
                                </div>
                                <button onclick="useSuggestedRoles()" class="mt-3 w-full py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                                    Use Suggested Roles in Search
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Profile -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4">üë§ 2. Your Profile</h2>
                        <form id="profile-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" id="first_name" placeholder="First Name" required maxlength="100"
                                    class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                                <input type="text" id="last_name" placeholder="Last Name" required maxlength="100"
                                    class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            </div>
                            <input type="email" id="profile-email" placeholder="Email" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            <input type="tel" id="phone" placeholder="Phone (e.g., 555-123-4567)" required pattern="[\d\s\-\+\(\)]{7,20}"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            <input type="url" id="linkedin_url" placeholder="LinkedIn URL (optional)" maxlength="200"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            <input type="number" id="years_experience" placeholder="Years of Experience" min="0" max="50"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                                Save Profile
                            </button>
                        </form>
                    </div>

                    <!-- LinkedIn Auth -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4">üîê LinkedIn Auth (Optional)</h2>
                        <p class="text-sm text-gray-600 mb-4">
                            For LinkedIn Easy Apply, paste your <code class="bg-gray-100 px-1 rounded">li_at</code> session cookie.
                            <button onclick="toggleCookieHelp()" class="text-purple-600 underline ml-1">How to get it?</button>
                        </p>
                        <div id="cookie-help" class="hidden mb-4 p-3 bg-blue-50 rounded-lg text-sm">
                            <ol class="list-decimal ml-4 space-y-1">
                                <li>Open LinkedIn in Chrome and log in</li>
                                <li>Press F12 ‚Üí Application tab ‚Üí Cookies ‚Üí linkedin.com</li>
                                <li>Find <code class="bg-blue-100 px-1 rounded">li_at</code> and copy its Value</li>
                                <li>Paste below (expires in ~1 year)</li>
                            </ol>
                        </div>
                        <div class="flex gap-2">
                            <input type="password" id="linkedin_cookie" placeholder="Paste li_at cookie value" maxlength="500"
                                class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none font-mono text-sm">
                            <button onclick="saveLinkedInCookie()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Save
                            </button>
                        </div>
                        <div id="cookie-status" class="mt-2 text-sm"></div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Job Search -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4">üîç 3. Search Jobs</h2>
                        <form id="search-form" class="space-y-4">
                            <input type="text" id="roles" placeholder="Job Titles (comma-separated)" maxlength="500"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            <input type="text" id="locations" placeholder="Locations (comma-separated)" maxlength="500"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">

                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="us-only" checked class="w-4 h-4 text-purple-600 rounded">
                                    <span class="text-sm font-medium text-gray-700">üá∫üá∏ US Jobs Only</span>
                                </label>
                                <select id="country-filter" class="px-3 py-1 text-sm border rounded-lg">
                                    <option value="US" selected>United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="DE">Germany</option>
                                    <option value="ALL">All Countries</option>
                                </select>
                            </div>

                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="easy_apply_only" checked class="rounded text-purple-600">
                                    <span class="text-sm">Easy Apply only</span>
                                </label>
                                <select id="posted_within" class="px-3 py-2 border rounded-lg">
                                    <option value="1">Past 24 hours</option>
                                    <option value="7" selected>Past week</option>
                                    <option value="30">Past month</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                                üîç Search Jobs
                            </button>
                        </form>
                    </div>

                    <!-- Results -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">üìã Results</h2>
                            <span id="results-count" class="text-sm text-gray-500"></span>
                        </div>
                        <div id="results" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-center py-8">Search results will appear here</p>
                        </div>
                    </div>

                    <!-- Campaign Mode Selection -->
                    <div class="card p-6 mb-6 border-2 border-purple-200 bg-purple-50">
                        <h2 class="text-xl font-semibold mb-4">üéÆ Campaign Mode</h2>
                        <div class="space-y-4">
                            <!-- Real vs Synthetic Toggle -->
                            <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                                <div>
                                    <span class="font-medium">Application Mode</span>
                                    <p class="text-xs text-gray-500" id="mode-description">Test mode - no real applications</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-blue-600 font-medium">Test</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="real_mode_toggle" class="sr-only peer">
                                        <div class="w-14 h-7 bg-blue-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-red-600"></div>
                                    </label>
                                    <span class="text-sm text-red-600 font-medium">REAL</span>
                                </div>
                            </div>
                            
                            <!-- Auto-submit vs Review Toggle -->
                            <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                                <div>
                                    <span class="font-medium">Submit Mode</span>
                                    <p class="text-xs text-gray-500" id="submit-description">Forms will be filled but NOT submitted</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-amber-600 font-medium">Review</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="submit_mode_toggle" class="sr-only peer">
                                        <div class="w-14 h-7 bg-amber-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                    <span class="text-sm text-green-600 font-medium">Auto</span>
                                </div>
                            </div>
                            
                            <!-- Warning Box -->
                            <div id="real-mode-warning" class="hidden p-4 bg-red-100 border-2 border-red-400 rounded-lg">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">‚ö†Ô∏è</span>
                                    <div>
                                        <h3 class="font-bold text-red-800">REAL APPLICATIONS MODE</h3>
                                        <p class="text-sm text-red-700 mt-1">
                                            When enabled, the system will ACTUALLY submit job applications. 
                                            You WILL receive confirmation emails from employers.
                                        </p>
                                        <p class="text-sm text-red-700 mt-1 font-semibold" id="auto-submit-warning">
                                            Auto-submit is OFF - forms will stop for your review.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cover Letter Option -->
                            <label class="flex items-center gap-2 p-3 bg-white rounded-lg">
                                <input type="checkbox" id="generate_cover_letter" checked class="rounded text-purple-600">
                                <span class="text-sm">Generate cover letters</span>
                            </label>
                        </div>
                    </div>

                    <!-- Batch Apply -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4">‚ö° Batch Apply</h2>
                        <div class="flex items-center gap-4 mb-4">
                            <button id="batch-apply-btn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium disabled:opacity-50" disabled>
                                üöÄ Apply to Selected Jobs (<span id="selected-count">0</span>)
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 text-center">
                            Mode: <span id="current-mode-display" class="font-medium text-blue-600">Test</span> | 
                            Submit: <span id="current-submit-display" class="font-medium text-amber-600">Review</span>
                        </p>
                    </div>

                    <!-- Single Apply -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4">üéØ Single Job Apply</h2>
                        <div id="linkedin-warning" class="mb-3 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800 hidden">
                            ‚ö†Ô∏è LinkedIn requires authentication. Add your li_at cookie above.
                        </div>
                        <form id="apply-form" class="space-y-4">
                            <input type="url" id="job_url" placeholder="Paste job URL" required maxlength="500"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                                üéØ Apply Now
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Applications History -->
            <div class="card p-6 mt-6">
                <h2 class="text-xl font-semibold mb-4">üìä Application History</h2>
                <div id="applications-log" class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Job</th>
                                <th class="px-4 py-2 text-left">Company</th>
                                <th class="px-4 py-2 text-left">Platform</th>
                                <th class="px-4 py-2 text-left">Status</th>
                                <th class="px-4 py-2 text-left">Time</th>
                            </tr>
                        </thead>
                        <tbody id="applications-tbody">
                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No applications yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Activity Log (User Visible) -->
            <div class="card p-6 mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">üìã Activity Log</h2>
                    <div class="flex gap-2">
                        <button onclick="loadUserActivity()" class="px-3 py-1 text-sm bg-gray-100 rounded-lg hover:bg-gray-200">Refresh</button>
                        <button onclick="toggleActivityLog()" class="px-3 py-1 text-sm bg-gray-100 rounded-lg hover:bg-gray-200">Toggle</button>
                    </div>
                </div>
                <div id="activity-log-container" class="max-h-80 overflow-y-auto">
                    <div id="activity-log-entries" class="space-y-2 text-sm">
                        <p class="text-gray-500 text-center py-4">Activity log shows all actions performed by the system on your behalf</p>
                    </div>
                </div>
            </div>

            <!-- Internal Testing Mode (Admin/Internal Use) -->
            <div id="testing-mode-section" class="card p-6 mt-6 border-2 border-dashed border-amber-300 bg-amber-50">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-amber-800">üß™ Internal Testing Mode</h2>
                    <span class="px-2 py-1 bg-amber-200 text-amber-800 text-xs rounded-full">Internal Use Only</span>
                </div>
                <p class="text-sm text-amber-700 mb-4">
                    Test job application form-filling with mock job files. No real applications are submitted.
                </p>
                
                <div class="space-y-4">
                    <div class="flex gap-4">
                        <select id="test-folder-select" class="flex-1 px-4 py-2 border rounded-lg">
                            <option value="">Select test folder...</option>
                        </select>
                        <button onclick="loadTestFolders()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Refresh</button>
                        <button onclick="createSampleJobs()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">Create Samples</button>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="test-auto-submit" class="rounded">
                            <span class="text-sm">Simulate submission (still won't actually apply)</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="test-log-activity" checked class="rounded">
                            <span class="text-sm">Log activity</span>
                        </label>
                    </div>
                    
                    <button onclick="runTestCampaign()" class="w-full py-3 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-medium">
                        ‚ñ∂Ô∏è Run Test Campaign
                    </button>
                </div>
                
                <!-- Test Results -->
                <div id="test-results" class="mt-4 hidden">
                    <h3 class="font-semibold mb-2">Test Results</h3>
                    <div id="test-results-content" class="bg-white p-4 rounded-lg text-sm space-y-2 max-h-60 overflow-y-auto">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const API_BASE = localStorage.getItem('api_base') || 'https://job-applier-api.fly.dev';

        // State
        let authToken = localStorage.getItem('auth_token');
        let userId = localStorage.getItem('user_id');
        let selectedJobs = new Set();
        let searchResults = [];
        let linkedInCookieSet = false;
        let parallelSessions = parseInt(localStorage.getItem('parallel_sessions')) || 10;
        
        // Campaign Mode State
        let campaignMode = {
            realMode: false,  // false = test/synthetic, true = real
            autoSubmit: false // false = review, true = auto-submit
        };

        // === Campaign Mode Toggle Handlers ===
        document.addEventListener('DOMContentLoaded', function() {
            const realModeToggle = document.getElementById('real_mode_toggle');
            const submitModeToggle = document.getElementById('submit_mode_toggle');
            const warningBox = document.getElementById('real-mode-warning');
            const autoSubmitWarning = document.getElementById('auto-submit-warning');
            const modeDesc = document.getElementById('mode-description');
            const submitDesc = document.getElementById('submit-description');
            const modeDisplay = document.getElementById('current-mode-display');
            const submitDisplay = document.getElementById('current-submit-display');
            
            // Real Mode Toggle
            realModeToggle.addEventListener('change', function() {
                campaignMode.realMode = this.checked;
                
                if (this.checked) {
                    // Real mode enabled
                    warningBox.classList.remove('hidden');
                    modeDesc.textContent = "REAL MODE - Will actually submit applications!";
                    modeDesc.classList.add('text-red-600', 'font-semibold');
                    modeDisplay.textContent = "REAL";
                    modeDisplay.className = "font-medium text-red-600";
                } else {
                    // Test mode
                    warningBox.classList.add('hidden');
                    modeDesc.textContent = "Test mode - no real applications";
                    modeDesc.classList.remove('text-red-600', 'font-semibold');
                    modeDisplay.textContent = "Test";
                    modeDisplay.className = "font-medium text-blue-600";
                }
                
                updateAutoSubmitWarning();
            });
            
            // Submit Mode Toggle
            submitModeToggle.addEventListener('change', function() {
                campaignMode.autoSubmit = this.checked;
                
                if (this.checked) {
                    // Auto-submit enabled
                    submitDesc.textContent = "Forms will be filled AND submitted automatically";
                    submitDesc.classList.add('text-green-600');
                    submitDisplay.textContent = "Auto";
                    submitDisplay.className = "font-medium text-green-600";
                } else {
                    // Review mode
                    submitDesc.textContent = "Forms will be filled but NOT submitted";
                    submitDesc.classList.remove('text-green-600');
                    submitDisplay.textContent = "Review";
                    submitDisplay.className = "font-medium text-amber-600";
                }
                
                updateAutoSubmitWarning();
            });
            
            function updateAutoSubmitWarning() {
                if (campaignMode.realMode && campaignMode.autoSubmit) {
                    autoSubmitWarning.textContent = "‚ö†Ô∏è WARNING: Auto-submit is ON - applications will be submitted automatically!";
                    autoSubmitWarning.className = "text-sm text-red-700 mt-1 font-bold";
                } else if (campaignMode.realMode && !campaignMode.autoSubmit) {
                    autoSubmitWarning.textContent = "Auto-submit is OFF - forms will stop for your review.";
                    autoSubmitWarning.className = "text-sm text-red-700 mt-1 font-semibold";
                } else {
                    autoSubmitWarning.textContent = "";
                }
            }
        });

        // === Speedometer Functions ===
        
        function updateSpeedometer(value) {
            value = parseInt(value);
            parallelSessions = value;
            localStorage.setItem('parallel_sessions', value);
            
            // Update needle rotation (-90 to 90 degrees based on 1-100)
            const rotation = -90 + (value / 100) * 180;
            const needle = document.getElementById('speed-needle');
            if (needle) {
                needle.setAttribute('transform', `rotate(${rotation}, 50, 50)`);
            }
            
            // Update labels
            const speedLabel = document.getElementById('speed-label');
            if (speedLabel) {
                speedLabel.textContent = `${value} session${value > 1 ? 's' : ''}`;
                // Color based on speed
                if (value <= 10) speedLabel.className = 'text-2xl font-bold text-green-600 mt-2';
                else if (value <= 30) speedLabel.className = 'text-2xl font-bold text-yellow-600 mt-2';
                else if (value <= 60) speedLabel.className = 'text-2xl font-bold text-orange-600 mt-2';
                else speedLabel.className = 'text-2xl font-bold text-red-600 mt-2';
            }
            
            // Estimate rate (roughly 0.4 apps/min per session based on testing)
            const estRate = Math.round(value * 0.4);
            const estRateEl = document.getElementById('est-rate');
            if (estRateEl) {
                estRateEl.textContent = `~${estRate}`;
            }
        }
        
        // Initialize speedometer on load
        document.addEventListener('DOMContentLoaded', () => {
            const slider = document.getElementById('parallel-sessions');
            if (slider) {
                slider.value = parallelSessions;
                updateSpeedometer(parallelSessions);
            }
        });

        // === Utility Functions ===

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function sanitizeText(text) {
            return String(text || '').replace(/[<>&"']/g, c => ({
                '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
            })[c]);
        }

        function showStatus(message, type = 'info') {
            const bar = document.getElementById('status-bar');
            const msg = document.getElementById('status-message');
            bar.className = `mb-6 p-4 rounded-lg ${
                type === 'error' ? 'bg-red-100 text-red-800' :
                type === 'success' ? 'bg-green-100 text-green-800' :
                'bg-blue-100 text-blue-800'
            }`;
            msg.textContent = message;
            bar.classList.remove('hidden');
            setTimeout(() => bar.classList.add('hidden'), 5000);
        }

        function authHeaders() {
            return authToken ? { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
        }

        // === Authentication ===

        function showLogin() {
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('register-form-container').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-form-container').classList.add('hidden');
            document.getElementById('register-form-container').classList.remove('hidden');
        }

        function showAuthError(message) {
            const el = document.getElementById('auth-error');
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function checkAuth() {
            if (authToken && userId) {
                document.getElementById('auth-container').classList.remove('active');
                document.getElementById('app-container').classList.add('active');
                document.getElementById('logout-btn').classList.remove('hidden');
                loadRateLimitStatus();
                loadApplications();
                loadSavedProfile();
            } else {
                document.getElementById('auth-container').classList.add('active');
                document.getElementById('app-container').classList.remove('active');
                document.getElementById('logout-btn').classList.add('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_id');
            authToken = null;
            userId = null;
            checkAuth();
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Login failed');

                authToken = data.access_token;
                userId = data.user_id;
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('user_id', userId);
                checkAuth();
            } catch (err) {
                showAuthError(err.message);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;

            if (password !== confirm) {
                showAuthError('Passwords do not match');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Registration failed');

                authToken = data.access_token;
                userId = data.user_id;
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('user_id', userId);
                checkAuth();
            } catch (err) {
                showAuthError(err.message);
            }
        });

        // === Profile Management ===

        function loadSavedProfile() {
            const saved = localStorage.getItem('profile');
            if (saved) {
                try {
                    const profile = JSON.parse(saved);
                    document.getElementById('first_name').value = profile.first_name || '';
                    document.getElementById('last_name').value = profile.last_name || '';
                    document.getElementById('profile-email').value = profile.email || '';
                    document.getElementById('phone').value = profile.phone || '';
                    document.getElementById('linkedin_url').value = profile.linkedin_url || '';
                    document.getElementById('years_experience').value = profile.years_experience || '';
                } catch (e) {}
            }
            // Also load search preferences
            const searchPrefs = localStorage.getItem('search_prefs');
            if (searchPrefs) {
                try {
                    const prefs = JSON.parse(searchPrefs);
                    document.getElementById('roles').value = prefs.roles || '';
                    document.getElementById('locations').value = prefs.locations || '';
                } catch (e) {}
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const profile = {
                first_name: document.getElementById('first_name').value.trim(),
                last_name: document.getElementById('last_name').value.trim(),
                email: document.getElementById('profile-email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                linkedin_url: document.getElementById('linkedin_url').value.trim() || null,
                years_experience: parseInt(document.getElementById('years_experience').value) || null
            };

            // Validate phone
            if (!/^[\d\s\-\+\(\)]{7,20}$/.test(profile.phone)) {
                showStatus('Invalid phone format', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/profile`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(profile)
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || 'Failed to save');
                }
                localStorage.setItem('profile', JSON.stringify(profile));
                showStatus('Profile saved!', 'success');
            } catch (err) {
                showStatus('Error: ' + err.message, 'error');
            }
        });

        // === Rate Limits ===

        async function loadRateLimitStatus() {
            try {
                const res = await fetch(`${API_BASE}/settings`, { headers: authHeaders() });
                if (!res.ok) return;
                const data = await res.json();
                updateRateLimitDisplay(data);
            } catch (e) {}
        }

        function updateRateLimitDisplay(data) {
            linkedInCookieSet = data.linkedin_cookie_set;
            if (linkedInCookieSet) {
                document.getElementById('cookie-status').textContent = '‚úÖ Cookie active';
                document.getElementById('cookie-status').className = 'mt-2 text-sm text-green-600';
            }

            const sent = data.sent_last_24h || 0;
            const limit = data.daily_limit || 10;
            const remaining = Math.max(0, limit - sent);
            const percentage = Math.min(100, (sent / limit) * 100);

            document.getElementById('sent-count').textContent = sent;
            document.getElementById('daily-limit-input').value = limit;
            document.getElementById('remaining-count').textContent = remaining;
            document.getElementById('limit-progress-bar').style.width = `${percentage}%`;

            const badge = document.getElementById('remaining-badge');
            badge.className = remaining === 0 ? 'text-center ml-4 px-4 py-2 rounded-lg bg-red-100 text-red-800' :
                remaining <= 3 ? 'text-center ml-4 px-4 py-2 rounded-lg bg-yellow-100 text-yellow-800' :
                'text-center ml-4 px-4 py-2 rounded-lg bg-green-100 text-green-800';
        }

        document.getElementById('daily-limit-input').addEventListener('change', async (e) => {
            const newLimit = parseInt(e.target.value);
            if (newLimit < 1 || newLimit > 1000) {
                showStatus('Limit must be 1-1000', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ daily_limit: newLimit })
                });
                const data = await res.json();
                updateRateLimitDisplay(data);
                showStatus('Limit updated', 'success');
            } catch (e) {
                showStatus('Failed to update limit', 'error');
            }
        });

        // === LinkedIn Cookie ===

        function toggleCookieHelp() {
            document.getElementById('cookie-help').classList.toggle('hidden');
        }

        async function saveLinkedInCookie() {
            const cookie = document.getElementById('linkedin_cookie').value.trim();
            if (!cookie) {
                document.getElementById('cookie-status').textContent = 'Please enter a cookie';
                document.getElementById('cookie-status').className = 'mt-2 text-sm text-red-600';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        daily_limit: parseInt(document.getElementById('daily-limit-input').value) || 10,
                        linkedin_cookie: cookie
                    })
                });
                const data = await res.json();
                if (data.linkedin_cookie_set) {
                    linkedInCookieSet = true;
                    document.getElementById('cookie-status').textContent = '‚úÖ Cookie saved!';
                    document.getElementById('cookie-status').className = 'mt-2 text-sm text-green-600';
                    document.getElementById('linkedin_cookie').value = '';
                    document.getElementById('linkedin-warning').classList.add('hidden');
                }
            } catch (e) {
                document.getElementById('cookie-status').textContent = 'Error: ' + e.message;
                document.getElementById('cookie-status').className = 'mt-2 text-sm text-red-600';
            }
        }

        // === Resume Upload ===

        document.getElementById('resume-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showStatus('File too large (max 10MB)', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showStatus('Uploading resume...');
                const res = await fetch(`${API_BASE}/resume/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Upload failed');

                const status = document.getElementById('resume-status');
                status.innerHTML = '';
                
                // Show upload success
                const div = document.createElement('div');
                div.className = 'p-3 bg-green-50 rounded-lg';
                const strong = document.createElement('strong');
                strong.textContent = '‚úÖ Uploaded: ';
                const span = document.createElement('span');
                span.textContent = file.name;
                div.appendChild(strong);
                div.appendChild(span);
                status.appendChild(div);
                
                // Show suggested job titles if available from response
                if (data.suggested_titles && data.suggested_titles.length > 0) {
                    const titlesDiv = document.createElement('div');
                    titlesDiv.className = 'mt-3 p-3 bg-purple-50 rounded-lg';
                    titlesDiv.innerHTML = '<strong class="text-purple-700">üéØ Suggested Job Titles:</strong>';
                    
                    const titlesWrap = document.createElement('div');
                    titlesWrap.className = 'flex flex-wrap gap-2 mt-2';
                    
                    data.suggested_titles.forEach(title => {
                        const chip = document.createElement('button');
                        chip.className = 'px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm hover:bg-purple-200 transition-colors';
                        chip.textContent = title;
                        chip.onclick = () => {
                            // Add to roles search field
                            const rolesInput = document.getElementById('roles');
                            const current = rolesInput.value.trim();
                            if (current) {
                                if (!current.toLowerCase().includes(title.toLowerCase())) {
                                    rolesInput.value = current + ', ' + title;
                                }
                            } else {
                                rolesInput.value = title;
                            }
                            chip.className = 'px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm';
                            chip.textContent = '‚úì ' + title;
                            saveProfileToLocal();
                        };
                        titlesWrap.appendChild(chip);
                    });
                    
                    titlesDiv.appendChild(titlesWrap);
                    status.appendChild(titlesDiv);
                    
                    // Also pre-fill roles if empty
                    const rolesInput = document.getElementById('roles');
                    if (!rolesInput.value.trim() && data.suggested_titles.length > 0) {
                        rolesInput.value = data.suggested_titles.slice(0, 3).join(', ');
                        saveProfileToLocal();
                    }
                }
                
                showStatus('Resume uploaded! Click suggested titles to add them to your search.', 'success');
                
                // Also load detailed AI-powered title suggestions
                setTimeout(() => loadTitleSuggestions(), 500);
            } catch (err) {
                showStatus('Upload failed: ' + err.message, 'error');
            }
        });

        // === Job Search ===

        document.getElementById('search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const roles = document.getElementById('roles').value;
            const locations = document.getElementById('locations').value;

            localStorage.setItem('search_prefs', JSON.stringify({ roles, locations }));

            const search = {
                roles: roles.split(',').map(s => s.trim()).filter(Boolean),
                locations: locations.split(',').map(s => s.trim()).filter(Boolean),
                easy_apply_only: document.getElementById('easy_apply_only').checked,
                posted_within_days: parseInt(document.getElementById('posted_within').value),
                country: document.getElementById('us-only').checked ? 'US' : document.getElementById('country-filter').value
            };

            document.getElementById('results').innerHTML = '<p class="text-center py-4">üîç Searching...</p>';
            selectedJobs.clear();
            updateSelectedCount();

            try {
                const res = await fetch(`${API_BASE}/jobs/search?platform=linkedin`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(search)
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail || 'Search failed');
                }
                const data = await res.json();
                searchResults = data.jobs || [];
                document.getElementById('results-count').textContent = `${data.count} jobs found`;
                renderResults();
                showStatus(`Found ${data.count} jobs`, 'success');
            } catch (err) {
                showStatus('Search failed: ' + err.message, 'error');
                document.getElementById('results').innerHTML = '<p class="text-center py-4 text-red-600">Search failed. Try single job apply.</p>';
            }
        });

        function renderResults() {
            const container = document.getElementById('results');
            container.innerHTML = '';

            if (searchResults.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No results</p>';
                return;
            }

            searchResults.forEach((job, idx) => {
                const div = document.createElement('div');
                div.className = `p-3 border rounded-lg hover:bg-gray-50 ${selectedJobs.has(idx) ? 'ring-2 ring-purple-500 bg-purple-50' : ''}`;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = selectedJobs.has(idx);
                checkbox.className = 'mt-1 rounded text-purple-600';
                checkbox.onchange = () => toggleJob(idx);

                const content = document.createElement('div');
                content.className = 'flex-1 ml-3';

                const title = document.createElement('div');
                title.className = 'font-medium';
                title.textContent = job.title;

                const meta = document.createElement('div');
                meta.className = 'text-sm text-gray-600';
                meta.textContent = `${job.company} ‚Ä¢ ${job.location}`;

                const badges = document.createElement('div');
                badges.className = 'flex items-center gap-2 mt-2 flex-wrap';

                if (job.easy_apply) {
                    const badge = document.createElement('span');
                    badge.className = 'text-xs bg-green-100 text-green-800 px-2 py-1 rounded';
                    badge.textContent = 'Easy Apply';
                    badges.appendChild(badge);
                }
                if (job.remote) {
                    const badge = document.createElement('span');
                    badge.className = 'text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded';
                    badge.textContent = 'üè† Remote';
                    badges.appendChild(badge);
                }

                const link = document.createElement('a');
                link.href = job.url;
                link.target = '_blank';
                link.className = 'text-xs text-purple-600 hover:underline';
                link.textContent = 'View ‚Üí';
                badges.appendChild(link);

                content.appendChild(title);
                content.appendChild(meta);
                content.appendChild(badges);

                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-start gap-3';
                wrapper.appendChild(checkbox);
                wrapper.appendChild(content);
                div.appendChild(wrapper);
                container.appendChild(div);
            });
        }

        function toggleJob(idx) {
            if (selectedJobs.has(idx)) selectedJobs.delete(idx);
            else selectedJobs.add(idx);
            updateSelectedCount();
            renderResults();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedJobs.size;
            document.getElementById('batch-apply-btn').disabled = selectedJobs.size === 0;
        }

        // === Apply ===

        document.getElementById('job_url').addEventListener('input', (e) => {
            const warning = document.getElementById('linkedin-warning');
            if (e.target.value.toLowerCase().includes('linkedin.com') && !linkedInCookieSet) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        });

        document.getElementById('apply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const jobUrl = document.getElementById('job_url').value.trim();
            if (!jobUrl) return;

            try {
                showStatus('Starting application...');
                const res = await fetch(`${API_BASE}/apply`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        job_url: jobUrl,
                        auto_submit: document.getElementById('auto_submit').checked,
                        generate_cover_letter: document.getElementById('generate_cover_letter').checked
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Application failed');
                showStatus(`Application started: ${data.application_id}`, 'success');
                document.getElementById('job_url').value = '';
                loadApplications();
                loadRateLimitStatus();
            } catch (err) {
                showStatus('Error: ' + err.message, 'error');
            }
        });

        document.getElementById('batch-apply-btn').addEventListener('click', async () => {
            const jobs = Array.from(selectedJobs).map(idx => searchResults[idx]);
            if (jobs.length === 0) return;

            // Get campaign mode settings
            const realMode = document.getElementById('real_mode_toggle').checked;
            const autoSubmit = document.getElementById('submit_mode_toggle').checked;
            const generateCover = document.getElementById('generate_cover_letter').checked;
            const sessions = parallelSessions || 10;
            
            // Confirmation for real mode
            if (realMode) {
                const modeText = autoSubmit ? "REAL APPLICATIONS with AUTO-SUBMIT" : "REAL APPLICATIONS with REVIEW";
                const confirmMessage = autoSubmit 
                    ? `‚ö†Ô∏è WARNING: You are about to ACTUALLY submit ${jobs.length} job applications!\n\n` +
                      `Mode: ${modeText}\n` +
                      `You WILL receive confirmation emails from employers.\n\n` +
                      `Are you absolutely sure you want to continue?`
                    : `You are about to process ${jobs.length} jobs in REAL mode.\n\n` +
                      `Forms will be filled but you'll review each before submission.\n\n` +
                      `Continue?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
            } else {
                showStatus(`Starting TEST campaign for ${jobs.length} jobs...`, 'info');
            }
            
            document.getElementById('progress-container').classList.remove('hidden');
            
            let completed = 0;
            let failed = 0;
            const startTime = Date.now();
            
            // Process jobs in parallel batches
            const processBatch = async (batch) => {
                const promises = batch.map(async (job) => {
                    try {
                        const res = await fetch(`${API_BASE}/apply`, {
                            method: 'POST',
                            headers: authHeaders(),
                            body: JSON.stringify({ 
                                job_url: job.url, 
                                auto_submit: autoSubmit, 
                                generate_cover_letter: generateCover,
                                parallel_sessions: sessions,
                                real_mode: realMode,
                                application_mode: realMode ? 'real' : 'synthetic'
                            })
                        });
                        if (res.ok) completed++;
                        else failed++;
                    } catch (e) { 
                        failed++; 
                    }
                    
                    // Update progress
                    const total = completed + failed;
                    const elapsed = (Date.now() - startTime) / 60000; // minutes
                    const rate = elapsed > 0 ? Math.round(total / elapsed) : 0;
                    
                    document.getElementById('progress-text').textContent = `${total} / ${jobs.length}`;
                    document.getElementById('progress-bar').style.width = `${(total / jobs.length) * 100}%`;
                    const modeIndicator = realMode ? 
                        (autoSubmit ? '<span class="text-red-600 font-bold">[REAL-AUTO]</span>' : '<span class="text-amber-600 font-bold">[REAL-REVIEW]</span>') :
                        '<span class="text-blue-600">[TEST]</span>';
                    
                    document.getElementById('progress-status').innerHTML = 
                        `${modeIndicator} ‚ö° ${sessions} sessions | ‚úÖ ${completed} | ‚ùå ${failed} | üìà ${rate}/min`;
                });
                await Promise.all(promises);
            };
            
            // Split jobs into batches of size 'sessions'
            for (let i = 0; i < jobs.length; i += sessions) {
                const batch = jobs.slice(i, i + sessions);
                await processBatch(batch);
            }

            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('progress-status').innerHTML = 
                `‚úÖ Complete! ${completed} submitted, ${failed} failed in ${elapsed}s`;
            showStatus(`Applied to ${completed} jobs in ${elapsed}s!`, 'success');
            loadApplications();
            loadRateLimitStatus();
            setTimeout(() => document.getElementById('progress-container').classList.add('hidden'), 5000);
        });

        // === Applications History ===

        async function loadApplications() {
            try {
                const res = await fetch(`${API_BASE}/applications`, { headers: authHeaders() });
                if (!res.ok) return;
                const data = await res.json();
                const tbody = document.getElementById('applications-tbody');
                tbody.innerHTML = '';

                if (!data.applications || data.applications.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 5;
                    td.className = 'px-4 py-8 text-center text-gray-500';
                    td.textContent = 'No applications yet';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                    return;
                }

                data.applications.forEach(app => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-t';

                    const tdJob = document.createElement('td');
                    tdJob.className = 'px-4 py-2';
                    tdJob.textContent = app.job_title || 'Job';

                    const tdCompany = document.createElement('td');
                    tdCompany.className = 'px-4 py-2';
                    tdCompany.textContent = app.company || '-';

                    const tdPlatform = document.createElement('td');
                    tdPlatform.className = 'px-4 py-2';
                    const platformSpan = document.createElement('span');
                    platformSpan.className = 'text-xs px-2 py-1 rounded bg-gray-100';
                    platformSpan.textContent = app.platform || 'unknown';
                    tdPlatform.appendChild(platformSpan);

                    const tdStatus = document.createElement('td');
                    tdStatus.className = 'px-4 py-2';
                    const statusSpan = document.createElement('span');
                    statusSpan.className = `px-2 py-1 rounded text-xs ${
                        app.status === 'submitted' ? 'bg-green-100 text-green-800' :
                        app.status === 'pending_review' ? 'bg-yellow-100 text-yellow-800' :
                        app.status === 'error' ? 'bg-red-100 text-red-800' :
                        'bg-gray-100'
                    }`;
                    statusSpan.textContent = app.status;
                    tdStatus.appendChild(statusSpan);

                    const tdTime = document.createElement('td');
                    tdTime.className = 'px-4 py-2 text-sm text-gray-500';
                    tdTime.textContent = app.created_at ? new Date(app.created_at).toLocaleString() : '-';

                    tr.appendChild(tdJob);
                    tr.appendChild(tdCompany);
                    tr.appendChild(tdPlatform);
                    tr.appendChild(tdStatus);
                    tr.appendChild(tdTime);
                    tbody.appendChild(tr);
                });
            } catch (e) {}
        }

        // === Profile Persistence (localStorage) ===
        function saveProfileToLocal() {
            const profile = {
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                linkedin_url: document.getElementById('linkedin_url').value,
                years_experience: document.getElementById('years_experience').value,
                roles: document.getElementById('roles').value,
                locations: document.getElementById('locations').value
            };
            localStorage.setItem('jobApplierProfile', JSON.stringify(profile));
        }

        function loadProfileFromLocal() {
            const saved = localStorage.getItem('jobApplierProfile');
            if (saved) {
                const profile = JSON.parse(saved);
                if (profile.first_name) document.getElementById('first_name').value = profile.first_name;
                if (profile.last_name) document.getElementById('last_name').value = profile.last_name;
                if (profile.email) document.getElementById('email').value = profile.email;
                if (profile.phone) document.getElementById('phone').value = profile.phone;
                if (profile.linkedin_url) document.getElementById('linkedin_url').value = profile.linkedin_url;
                if (profile.years_experience) document.getElementById('years_experience').value = profile.years_experience;
                if (profile.roles) document.getElementById('roles').value = profile.roles;
                if (profile.locations) document.getElementById('locations').value = profile.locations;
            }
        }

        // Auto-save on input change
        ['first_name', 'last_name', 'email', 'phone', 'linkedin_url', 'years_experience', 'roles', 'locations'].forEach(id => {
            document.getElementById(id)?.addEventListener('change', saveProfileToLocal);
        });

        // === Job Title Suggestions ===
        
        let currentSuggestedRoles = [];
        
        async function loadTitleSuggestions() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_BASE}/resume/suggest-titles`, {
                    headers: authHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayTitleSuggestions(data);
                }
            } catch (e) {
                console.error('Error loading title suggestions:', e);
            }
        }
        
        function displayTitleSuggestions(data) {
            currentSuggestedRoles = data.suggested_roles || [];
            
            // Show the container
            document.getElementById('title-suggestions').classList.remove('hidden');
            
            // Display role pills
            const rolesList = document.getElementById('suggested-roles-list');
            rolesList.innerHTML = '';
            
            data.suggested_roles.forEach((role, idx) => {
                const pill = document.createElement('span');
                pill.className = `px-3 py-1 rounded-full text-sm font-medium cursor-pointer transition-colors ${
                    idx === 0 ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'
                }`;
                pill.textContent = role;
                pill.onclick = () => {
                    document.getElementById('roles').value = role;
                    showStatus(`Role "${role}" set in search`, 'success');
                };
                rolesList.appendChild(pill);
            });
            
            // Display detailed suggestions
            const detailsContainer = document.getElementById('suggested-titles-details');
            detailsContainer.innerHTML = '';
            
            if (data.titles && data.titles.length > 0) {
                data.titles.slice(0, 3).forEach(title => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 bg-white rounded border';
                    div.innerHTML = `
                        <div>
                            <span class="font-medium">${escapeHtml(title.title)}</span>
                            <span class="text-xs text-gray-500 ml-2">${escapeHtml(title.experience_level)}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${title.relevance_score}%"></div>
                            </div>
                            <span class="text-xs text-gray-600">${title.relevance_score}%</span>
                        </div>
                    `;
                    detailsContainer.appendChild(div);
                });
            }
            
            // Show experience level and salary range
            if (data.experience_level) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'mt-3 pt-3 border-t border-purple-200 text-xs text-purple-700';
                metaDiv.innerHTML = `
                    <div class="flex justify-between">
                        <span>Experience Level: <strong>${data.experience_level}</strong></span>
                        <span>Est. Salary: <strong>$${(data.salary_range?.min || 0).toLocaleString()} - $${(data.salary_range?.max || 0).toLocaleString()}</strong></span>
                    </div>
                `;
                detailsContainer.appendChild(metaDiv);
            }
        }
        
        function useSuggestedRoles() {
            if (currentSuggestedRoles.length === 0) return;
            
            const rolesInput = document.getElementById('roles');
            rolesInput.value = currentSuggestedRoles.join(', ');
            showStatus(`Set ${currentSuggestedRoles.length} suggested roles in search`, 'success');
            
            // Save to localStorage
            saveProfileToLocal();
        }
        
        // === User Activity Log ===
        
        let activityLogVisible = true;
        
        function toggleActivityLog() {
            const container = document.getElementById('activity-log-container');
            activityLogVisible = !activityLogVisible;
            container.classList.toggle('hidden', !activityLogVisible);
        }
        
        async function loadUserActivity() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_BASE}/user/activity?limit=50`, {
                    headers: authHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayActivityLog(data.activities || []);
                }
            } catch (e) {
                console.error('Error loading activity log:', e);
            }
        }
        
        function displayActivityLog(activities) {
            const container = document.getElementById('activity-log-entries');
            
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity</p>';
                return;
            }
            
            container.innerHTML = '';
            
            activities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'flex items-start gap-3 p-2 rounded hover:bg-gray-50';
                
                const timestamp = activity.timestamp ? new Date(activity.timestamp).toLocaleTimeString() : '-';
                const action = activity.action || 'UNKNOWN';
                
                // Icon based on action type
                let icon = 'üìù';
                if (action.includes('APPLY')) icon = 'üöÄ';
                if (action.includes('SEARCH')) icon = 'üîç';
                if (action.includes('RESUME')) icon = 'üìÑ';
                if (action.includes('ERROR')) icon = '‚ùå';
                if (action.includes('TEST')) icon = 'üß™';
                
                div.innerHTML = `
                    <span class="text-lg">${icon}</span>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <span class="font-medium text-gray-800">${escapeHtml(action)}</span>
                            <span class="text-xs text-gray-400">${timestamp}</span>
                        </div>
                        ${activity.details ? `<div class="text-xs text-gray-500 truncate">${escapeHtml(JSON.stringify(activity.details))}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }
        
        // === Internal Testing Mode ===
        
        async function loadTestFolders() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_BASE}/test/list-folders`, {
                    headers: authHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('test-folder-select');
                    
                    // Keep first option
                    select.innerHTML = '<option value="">Select test folder...</option>';
                    
                    data.folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.path;
                        option.textContent = `${folder.name} (${folder.job_count} jobs)`;
                        select.appendChild(option);
                    });
                    
                    if (data.folders.length === 0) {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "No test folders found - create samples below";
                        option.disabled = true;
                        select.appendChild(option);
                    }
                }
            } catch (e) {
                console.error('Error loading test folders:', e);
                showStatus('Error loading test folders', 'error');
            }
        }
        
        async function createSampleJobs() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_BASE}/test/create-sample-jobs?folder_name=sample_jobs`, {
                    method: 'POST',
                    headers: authHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus(`Created ${data.files.length} sample job files`, 'success');
                    loadTestFolders();
                } else {
                    showStatus('Failed to create sample jobs', 'error');
                }
            } catch (e) {
                console.error('Error creating sample jobs:', e);
                showStatus('Error creating sample jobs', 'error');
            }
        }
        
        async function runTestCampaign() {
            if (!authToken) return;
            
            const folderPath = document.getElementById('test-folder-select').value;
            if (!folderPath) {
                showStatus('Please select a test folder', 'error');
                return;
            }
            
            const autoSubmit = document.getElementById('test-auto-submit').checked;
            const logActivity = document.getElementById('test-log-activity').checked;
            
            showStatus('Running test campaign...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/test/apply-folder`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        job_folder_path: folderPath,
                        auto_submit: autoSubmit,
                        log_activity: logActivity
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayTestResults(data);
                    loadUserActivity(); // Refresh activity log
                    showStatus(`Test complete: ${data.successful}/${data.total_jobs} jobs processed`, 'success');
                } else {
                    const error = await response.json();
                    showStatus(error.detail || 'Test campaign failed', 'error');
                }
            } catch (e) {
                console.error('Error running test campaign:', e);
                showStatus('Error running test campaign', 'error');
            }
        }
        
        function displayTestResults(data) {
            const container = document.getElementById('test-results');
            const content = document.getElementById('test-results-content');
            
            container.classList.remove('hidden');
            
            let html = `
                <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
                    <span><strong>Test ID:</strong> ${escapeHtml(data.test_id)}</span>
                    <span class="text-green-600 font-bold">${data.successful}/${data.total_jobs} ‚úì</span>
                </div>
                <div class="text-sm text-gray-600">${escapeHtml(data.summary)}</div>
                <div class="space-y-2 mt-3">
            `;
            
            data.results.forEach((result, idx) => {
                const statusColor = result.status === 'dry_run_success' ? 'text-green-600' : 
                                   result.status === 'failed' ? 'text-red-600' : 'text-blue-600';
                const statusIcon = result.status === 'dry_run_success' ? '‚úì' : 
                                  result.status === 'failed' ? '‚úó' : '‚Üí';
                
                html += `
                    <div class="p-2 border rounded ${result.status === 'failed' ? 'bg-red-50' : 'bg-white'}">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${idx + 1}. ${escapeHtml(result.job_title)} @ ${escapeHtml(result.company)}</span>
                            <span class="${statusColor}">${statusIcon} ${escapeHtml(result.status)}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Fields filled: ${result.form_fields_filled}/${result.form_fields_total}
                            ${result.errors.length > 0 ? `<span class="text-red-500 ml-2">Errors: ${result.errors.join(', ')}</span>` : ''}
                        </div>
                        ${result.activity_log.length > 0 ? `
                            <div class="mt-2 pl-3 border-l-2 border-gray-200 text-xs text-gray-600">
                                ${result.activity_log.slice(0, 5).map(log => `
                                    <div>‚Ä¢ ${escapeHtml(log.action)}: ${escapeHtml(JSON.stringify(log).substring(0, 100))}</div>
                                `).join('')}
                                ${result.activity_log.length > 5 ? `<div class="text-gray-400">+ ${result.activity_log.length - 5} more actions</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // Initialize
        if (typeof checkAuth === 'function') checkAuth();
        loadProfileFromLocal();
        setInterval(loadRateLimitStatus, 60000);
        setInterval(loadApplications, 30000);
        setInterval(loadUserActivity, 30000); // Refresh activity log every 30s
        
        // Load initial data after auth check
        setTimeout(() => {
            if (authToken) {
                loadUserActivity();
                loadTestFolders();
                loadTitleSuggestions();
            }
        }, 1000);
    </script>
</body>
</html>
