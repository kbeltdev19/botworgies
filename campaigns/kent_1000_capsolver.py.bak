#!/usr/bin/env python3
"""
KENT LE - 1000 JOB CAMPAIGN WITH CAPSOLVER

This campaign:
1. Uses CapSolver for CAPTCHA solving (~$3-15 cost)
2. Applies to 1000 jobs with honest validation
3. Tracks real submissions only (with success indicators)
4. Properly detects and handles Cloudflare
5. Provides detailed reporting

Usage:
    CAPSOLVER_API_KEY=xxx python kent_1000_capsolver.py

Required:
    - CAPSOLVER_API_KEY environment variable
    - Resume file at Test Resumes/Kent_Le_Resume.pdf
"""

import os
import sys
import asyncio
import json
import random
from datetime import datetime
from pathlib import Path
from typing import List, Dict, Optional
from dataclasses import dataclass, field, asdict

sys.path.insert(0, str(Path(__file__).parent.parent))

from browser.stealth_manager import StealthBrowserManager
from browser.captcha_manager import get_captcha_manager
from adapters import (
    JobSpyAdapter, SearchConfig, UserProfile, Resume,
    ApplicationStatus, JobPosting, ApplicationResult,
    get_adapter
)
from adapters.validation_fixed import SubmissionValidatorFixed
from adapters.error_logger import get_error_logger

# Kent Le Profile
KENT_PROFILE = UserProfile(
    first_name="Kent",
    last_name="Le",
    email="kle4311@gmail.com",
    phone="(404) 934-0630",
    location="Auburn, AL",
    linkedin_url="https://linkedin.com/in/kent-le",
    work_authorization="Yes",
    sponsorship_required="No",
    years_experience=3,
    custom_answers={
        "salary_expectation": "75000",
        "start_date": "Immediately",
        "relocation": "No"
    }
)

RESUME_PATH = "/Users/tech4/Downloads/botworkieslocsl/botworgies/Test Resumes/Kent_Le_Resume.pdf"


@dataclass
class CampaignStats:
    """Track campaign statistics."""
    total_attempted: int = 0
    real_submissions: int = 0
    cloudflare_blocked: int = 0
    captcha_solved: int = 0
    captcha_failed: int = 0
    form_errors: int = 0
    external_redirect: int = 0
    other_errors: int = 0
    captcha_cost: float = 0.0
    browserbase_cost: float = 0.0
    start_time: datetime = field(default_factory=datetime.now)
    end_time: Optional[datetime] = None
    
    @property
    def real_success_rate(self) -> float:
        return (self.real_submissions / max(self.total_attempted, 1)) * 100
    
    @property
    def duration_minutes(self) -> float:
        end = self.end_time or datetime.now()
        return (end - self.start_time).total_seconds() / 60
    
    def to_dict(self) -> dict:
        return {
            **asdict(self),
            "real_success_rate": self.real_success_rate,
            "duration_minutes": self.duration_minutes
        }


class Kent1000CapSolverCampaign:
    """1000 job campaign with CapSolver CAPTCHA solving."""
    
    def __init__(self, target_jobs: int = 1000):
        self.target_jobs = target_jobs
        self.stats = CampaignStats()
        self.results: List[Dict] = []
        
        timestamp = datetime.now().strftime('%Y%m%d_%H%M')
        self.output_dir = Path(__file__).parent / "output" / f"kent_1000_capsolver_{timestamp}"
        self.output_dir.mkdir(parents=True, exist_ok=True)
        
        self.resume = Resume(
            file_path=RESUME_PATH,
            raw_text="",
            parsed_data={"name": "Kent Le", "email": "kle4311@gmail.com"}
        )
        
        self.error_logger = get_error_logger(str(self.output_dir / "errors"))
        self.browser_manager: Optional[StealthBrowserManager] = None
        
        # Check CapSolver configuration
        self.captcha_manager = get_captcha_manager()
        
        print("="*70)
        print("üöÄ KENT LE - 1000 JOB CAMPAIGN WITH CAPSOLVER")
        print("="*70)
        print()
        print(f"Target: {target_jobs} jobs")
        print(f"Output: {self.output_dir}")
        print()
        
        if self.captcha_manager.is_configured():
            print("‚úÖ CapSolver configured - CAPTCHA solving ENABLED")
            print(f"   API Key: {self.captcha_manager.api_key[:8]}...")
        else:
            print("‚ö†Ô∏è  CapSolver NOT configured")
            print("   Set CAPSOLVER_API_KEY environment variable")
            print("   Get API key from: https://capsolver.com")
        
        print()
    
    async def initialize(self):
        """Initialize browser manager."""
        self.browser_manager = StealthBrowserManager()
        await self.browser_manager.initialize()
        print("‚úÖ Browser manager initialized")
    
    async def get_jobs(self) -> List[JobPosting]:
        """Search for jobs using JobSpy."""
        print("\nüîç Searching for jobs...")
        
        search_config = SearchConfig(
            roles=["software engineer", "backend developer", "full stack developer"],
            locations=["Remote", "Auburn, AL", "Atlanta, GA", "Birmingham, AL"],
            posted_within_days=7,
            experience_levels=["entry"],
            easy_apply_only=True,
            country="US"
        )
        
        adapter = JobSpyAdapter()
        jobs = await adapter.search_jobs(search_config)
        
        print(f"‚úÖ Found {len(jobs)} jobs")
        return jobs[:self.target_jobs]
    
    async def apply_to_job(self, job: JobPosting, job_num: int) -> Dict:
        """Apply to a single job with CAPTCHA solving."""
        print(f"\n{'='*70}")
        print(f"üìã Job {job_num}/{self.target_jobs}: {job.title} at {job.company}")
        print(f"   Location: {job.location}")
        print(f"   URL: {job.url[:70]}...")
        print("="*70)
        
        result = {
            "job_id": job.id,
            "title": job.title,
            "company": job.company,
            "url": job.url,
            "timestamp": datetime.now().isoformat(),
            "success": False,
            "validation": None,
            "error": None,
            "captcha_solved": False
        }
        
        session = None
        
        try:
            # Create browser session (BrowserBase preferred, local fallback)
            print("  [1/5] Creating browser session...")
            session = await self.browser_manager.create_stealth_session(
                platform="indeed",
                use_proxy=True
            )
            page = session.page
            print(f"      ‚úÖ Session: {session.mode.value}")
            
            # Navigate to job page
            print("  [2/5] Navigating to job page...")
            await page.goto(job.url, timeout=30000)
            await self.browser_manager.human_like_delay(2, 4)
            
            # Handle Cloudflare/CAPTCHA if present
            print("  [3/5] Checking for CAPTCHA...")
            captcha_result = await self.captcha_manager.detect_and_solve(page)
            
            if captcha_result.success:
                print(f"      ‚úÖ CAPTCHA solved (${captcha_result.cost:.4f})")
                self.stats.captcha_solved += 1
                self.stats.captcha_cost += captcha_result.cost
                result["captcha_solved"] = True
                await self.browser_manager.human_like_delay(3, 5)
            elif "No recognized CAPTCHA" not in str(captcha_result.error):
                print(f"      ‚ùå CAPTCHA solve failed: {captcha_result.error}")
                self.stats.captcha_failed += 1
            else:
                print("      ‚ÑπÔ∏è  No CAPTCHA detected")
            
            # Wait for Cloudflare to clear
            cloudflare_cleared = await self.browser_manager.wait_for_cloudflare(page, timeout=20)
            if not cloudflare_cleared:
                print("      ‚ö†Ô∏è  Cloudflare still present")
                self.stats.cloudflare_blocked += 1
                result["error"] = "Cloudflare blocked"
                return result
            
            # Get appropriate adapter
            print("  [4/5] Getting job details...")
            platform = self._detect_platform(job.url)
            adapter = get_adapter(platform, self.browser_manager, None)
            
            # Get full job details
            job_details = await adapter.get_job_details(job.url)
            await self.browser_manager.human_like_delay(1, 2)
            
            # Apply to job
            print("  [5/5] Applying...")
            app_result = await adapter.apply_to_job(
                job=job_details,
                resume=self.resume,
                profile=KENT_PROFILE,
                cover_letter="",
                auto_submit=True
            )
            
            # Validate submission
            validation = await SubmissionValidatorFixed.validate(page, job.id)
            result["validation"] = validation
            
            if validation.get("success"):
                print("      ‚úÖ REAL SUBMISSION - Success indicators found!")
                self.stats.real_submissions += 1
                result["success"] = True
            elif validation.get("is_cloudflare"):
                print("      ‚ùå Cloudflare blocked submission")
                self.stats.cloudflare_blocked += 1
                result["error"] = "Cloudflare blocked"
            else:
                print(f"      ‚ùå No success indicators - {validation.get('message', 'Unknown')}")
                self.stats.other_errors += 1
                result["error"] = validation.get("message", "No success indicators")
            
            # Take final screenshot
            screenshot_path = self.output_dir / "screenshots" / f"{job.id}.png"
            screenshot_path.parent.mkdir(parents=True, exist_ok=True)
            await page.screenshot(path=str(screenshot_path))
            result["screenshot"] = str(screenshot_path)
            
        except Exception as e:
            error_msg = str(e)
            print(f"      ‚ùå ERROR: {error_msg[:100]}")
            self.stats.other_errors += 1
            result["error"] = error_msg
            
            # Log error
            self.error_logger.log_error(
                job_id=job.id,
                company=job.company,
                job_title=job.title,
                job_url=job.url,
                error_message=str(e),
                exception=e,
                context={"platform": platform}
            )
            
        finally:
            if session:
                await self.browser_manager.close_session(session.session_id)
        
        return result
    
    def _detect_platform(self, url: str) -> str:
        """Detect job platform from URL."""
        url_lower = url.lower()
        if "indeed.com" in url_lower:
            return "indeed"
        elif "linkedin.com" in url_lower:
            return "linkedin"
        elif "greenhouse.io" in url_lower:
            return "greenhouse"
        elif "lever.co" in url_lower:
            return "lever"
        elif "workday.com" in url_lower or "myworkdayjobs.com" in url_lower:
            return "workday"
        return "generic"
    
    async def run(self):
        """Run the full campaign."""
        # Confirmation
        print("\n" + "="*70)
        print("‚ö†Ô∏è  CONFIRMATION REQUIRED")
        print("="*70)
        print(f"\nThis will apply to {self.target_jobs} jobs with CAPTCHA solving.")
        print(f"\nEstimated costs:")
        print(f"  - BrowserBase: ~${self.target_jobs * 0.05:.0f}-${self.target_jobs * 0.10:.0f}")
        print(f"  - CapSolver: ~${self.target_jobs * 0.003:.0f}-${self.target_jobs * 0.01:.0f}")
        print(f"  - Total: ~${self.target_jobs * 0.05 + self.target_jobs * 0.003:.0f}-${self.target_jobs * 0.11:.0f}")
        print(f"\nWith 30-50% success rate, expect {int(self.target_jobs * 0.3)}-{int(self.target_jobs * 0.5)} real submissions.")
        
        if self.captcha_manager.is_configured():
            print(f"\n‚úÖ CapSolver is ready")
        else:
            print(f"\n‚ùå CapSolver NOT configured - will get 0% success rate")
            print("   Set CAPSOLVER_API_KEY to continue")
            return
        
        confirm = input("\nType 'CAPSOLVER1000' to start: ")
        if confirm.strip() != "CAPSOLVER1000":
            print("‚ùå Cancelled")
            return
        
        # Initialize
        await self.initialize()
        
        # Get jobs
        jobs = await self.get_jobs()
        
        if len(jobs) < self.target_jobs:
            print(f"‚ö†Ô∏è  Only found {len(jobs)} jobs, adjusting target")
            self.target_jobs = len(jobs)
        
        # Process jobs
        print(f"\nüöÄ Starting applications...")
        print(f"   Target: {self.target_jobs} jobs")
        print(f"   Started: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print()
        
        for i, job in enumerate(jobs[:self.target_jobs], 1):
            self.stats.total_attempted = i
            
            result = await self.apply_to_job(job, i)
            self.results.append(result)
            
            # Save progress every 10 jobs
            if i % 10 == 0:
                await self._save_checkpoint()
                self._print_progress()
            
            # Delay between jobs
            delay = random.uniform(3, 8)
            print(f"\n‚è≥ Waiting {delay:.1f}s before next job...")
            await asyncio.sleep(delay)
        
        # Finalize
        self.stats.end_time = datetime.now()
        await self._save_final_report()
        
        print("\n" + "="*70)
        print("üéâ CAMPAIGN COMPLETE")
        print("="*70)
        self._print_final_stats()
    
    async def _save_checkpoint(self):
        """Save progress checkpoint."""
        checkpoint = {
            "timestamp": datetime.now().isoformat(),
            "stats": self.stats.to_dict(),
            "recent_results": self.results[-10:]
        }
        checkpoint_path = self.output_dir / "checkpoint.json"
        with open(checkpoint_path, 'w') as f:
            json.dump(checkpoint, f, indent=2, default=str)
    
    async def _save_final_report(self):
        """Save final campaign report."""
        report = {
            "campaign": "kent_1000_capsolver",
            "profile": {
                "name": "Kent Le",
                "email": "kle4311@gmail.com",
                "location": "Auburn, AL"
            },
            "stats": self.stats.to_dict(),
            "captcha_stats": self.captcha_manager.get_stats(),
            "results": self.results,
            "output_dir": str(self.output_dir)
        }
        
        report_path = self.output_dir / "final_report.json"
        with open(report_path, 'w') as f:
            json.dump(report, f, indent=2, default=str)
        
        # Also save error log
        self.error_logger.save_report()
        
        print(f"\nüíæ Report saved: {report_path}")
    
    def _print_progress(self):
        """Print current progress."""
        print("\n" + "-"*70)
        print("üìä PROGRESS UPDATE")
        print("-"*70)
        print(f"  Attempted: {self.stats.total_attempted}/{self.target_jobs}")
        print(f"  Real Submissions: {self.stats.real_submissions} ({self.stats.real_success_rate:.1f}%)")
        print(f"  CAPTCHA Solved: {self.stats.captcha_solved}")
        print(f"  CAPTCHA Cost: ${self.stats.captcha_cost:.2f}")
        print(f"  Cloudflare Blocked: {self.stats.cloudflare_blocked}")
        print(f"  Duration: {self.stats.duration_minutes:.1f} minutes")
        print("-"*70)
    
    def _print_final_stats(self):
        """Print final statistics."""
        print(f"\nüìä FINAL STATISTICS")
        print("="*70)
        print(f"  Total Attempted: {self.stats.total_attempted}")
        print(f"  ‚úÖ Real Submissions: {self.stats.real_submissions}")
        print(f"  üìà Actual Success Rate: {self.stats.real_success_rate:.1f}%")
        print()
        print(f"  üîê CAPTCHA Stats:")
        print(f"     Solved: {self.stats.captcha_solved}")
        print(f"     Failed: {self.stats.captcha_failed}")
        print()
        print(f"  üí∞ Costs:")
        print(f"     CAPTCHA: ${self.stats.captcha_cost:.2f}")
        print(f"     Estimated BrowserBase: ${self.stats.browserbase_cost:.2f}")
        print(f"     Total: ${self.stats.captcha_cost + self.stats.browserbase_cost:.2f}")
        print()
        print(f"  ‚è±Ô∏è  Duration: {self.stats.duration_minutes:.1f} minutes")
        print(f"  üìÅ Output: {self.output_dir}")
        print("="*70)
        
        if self.stats.real_submissions > 0:
            print(f"\nüéâ SUCCESS! {self.stats.real_submissions} real job applications submitted!")
        else:
            print(f"\n‚ö†Ô∏è  No real submissions achieved. Consider:")
            print("   - Checking CAPTCHA solver configuration")
            print("   - Reviewing screenshots in output directory")
            print("   - Trying different job platforms")


async def main():
    """Main entry point."""
    campaign = Kent1000CapSolverCampaign(target_jobs=1000)
    
    try:
        await campaign.run()
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Campaign interrupted by user")
        await campaign._save_checkpoint()
        print("üíæ Checkpoint saved")
    except Exception as e:
        print(f"\n\n‚ùå Campaign error: {e}")
        import traceback
        traceback.print_exc()
        await campaign._save_checkpoint()


if __name__ == "__main__":
    asyncio.run(main())
